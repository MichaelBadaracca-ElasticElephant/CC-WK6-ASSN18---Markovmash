<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Markov Mash</title>
	<script
  src="https://code.jquery.com/jquery-3.2.1.js"
  integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE="
  crossorigin="Markov Mash"></script>
</head>
<body>
    <h1 id="markov-tweet"></h1>
    <div id="username-inputs">
        <input type="text" id="input-username" class="username">
    </div>
	
	<button id="send-username">Make Markov Tweet</button>
    <button id="add-username-field">Add Another User</button>
	<div id="error" style="display: none; color: red;">You must enter a name.</div>

	<script>

         //create a button to add more fields to mash up
        //if there are multiple feilds change 
        $(document).ready(function () {
            var numOfInputs = 1;
            //Add more input feilds to mash up more users when clicking button
            $("#add-username-field").click(function () {
                numOfInputs++;
                //Build html for new input field and button to remove field. Give them inique ids based on the numOfInputs value
                var inputId = "input-username-" + numOfInputs;
                var removeInputButtonId = "remove-input-" + numOfInputs;
                var newUsernameInput = "<input type='text' id='" + inputId + "' class='username'>";
                var removeInputButton = "<button id='" + removeInputButtonId + "'>X</button>"; 

                //Append new text box input
                $('#username-inputs').append(newUsernameInput);
                //Append new button to remove textbox with a click handler to remove the textbox and itself
                //Referenced solution from this resource: http://stackoverflow.com/questions/1525664/jquery-how-to-bind-onclick-event-to-dynamically-added-html-element
                $('#username-inputs').append(function () {
                    return $(removeInputButton).click(function () {
                        $('#' + inputId).remove();
                        $('#' + removeInputButtonId).remove();
                        numOfInputs--;
                    })
                });
            });

            //for each textbox, grab the value. If there are more than one textbox, make a different request

            //Steps
                //get content from multiple dynamically created textboxes and store them in an array
                //if there is more than one element in the array, make an api call indicating we want to train from all the sources
                //on backend, find a way to carryout the markov generatation that trains on each of the inpouts
                    //could send a different request to train a data set and then another request to generate the markov chain


            $('#send-username').click(function () {
                console.log("*** CLICKED ***");
                var generateUrl = "/api/tweets/generate/";

                var trainUsersPromise = new Promise(resolve => {
                    //var user = $('#input-username').val();


                    //loop through all inputs with the class username and put their value into an array
                    var users = getUsersFromInputFields();
                    console.log(users);

                    //for (var userCount = 0; userCount < users.length; userCount++) {
                    //    var trainUrl = "/api/tweets/train/" + users[userCount];
                    //    console.log(trainUrl);
                    //    if (users[userCount]) {
                    //        $('#error').slideUp();
                    //        $.get(trainUrl, function (response) {
                    //            console.log("Response: " + response);
                    //            //Resolve the promise once the last response from the last user training has been recieved
                    //            if (userCount == users.length) {
                    //                console.log("Last user finished");
                    //                resolve(response);
                                    
                    //            }
                    //        });
                    //    } else {
                    //        $('#error').slideDown();
                    //    }
                    //}


                    var userCount = 0;
                    var previousUserCount = userCount;
                    while (userCount < users.length) {
                        //only execute code once the previous get request has recieved a response
                        //can check this by seeing if the userCount has increased
                        if (userCount === previousUserCount + 1) {
                            var trainUrl = "/api/tweets/train/" + users[userCount];
                            console.log(trainUrl);
                            if (users[userCount]) {
                                $('#error').slideUp();
                                $.get(trainUrl, function (response) {
                                    console.log("Response: " + response);
                                    debugger;
                                    //increment the userCount only once a response has been recieved
                                    //tried using for loop and count updated before response was recieved back
                                    userCount++;
                                    //Resolve the promise once the last response from the last user training has been recieved
                                    if (userCount == users.length) {
                                        console.log("Last user finished");
                                        resolve(response);
                                    }
                                });
                            } else {
                                $('#error').slideDown();
                            }
                        }
                        
                    }


                    //resolve();
                })

                trainUsersPromise.then(function () {

                     //once tweets are trained, generate the markov chain
                    console.log("All training done");
                    console.log(generateUrl);
                    $.get(generateUrl, function (markovTweet) {
                        $('#markov-tweet').text(markovTweet);
                    });
                })
                //var user = $('#input-username').val();
               
                //var generateUrl = "/api/tweets/generate/";

                ////loop through all inputs with the class username and put their value into an array
                //var users = [];
                //$(".username").each(function () {
                //    users.push($(this).val());
                //});
                //console.log(users);

                //for (user of users) {
                //    var trainUrl = "/api/tweets/train/" + user;
                //    console.log(trainUrl);
                //    if (user) {
                //        $('#error').slideUp();
                //        //$.get(trainUrl, function (response) {
                //        //    //console.log("Respnse: " + response);
                //        //    //once tweets are trained, generate the markov chain
                            
                //        //    //$('#markov-tweet').text(markovTweet);
                //        //});

                //    } else {
                //        $('#error').slideDown();
                //    }
                //}






            });

            function getUsersFromInputFields() {
                var users = [];
                $(".username").each(function () {
                    users.push($(this).val());
                });
                return users;
            }

            

        });



	</script>
</body>
</html>
